---
title: "Assignment 5: Substance Abuse Treatment Mapping"
subtitle: "STUDENT NAME"
author: "Amber Camp"
date: "`r Sys.Date()`"
format: html
editor: visual
---

## Overview

Due: **Tuesday, 10/7 11:59pm**

In this assignment, you will apply analytic and mapping skills on the TEDS-D dataset from SAMHSA.

Refer to the following files for reference, though some of what is asked of you in this assignment will require logic beyond what was discussed here:

-   week06-treatment-mapping-part1.qmd

-   week06-treatment-mapping-part2.qmd

Total time estimate: Two hours

## Load Packages and Data

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
library(janitor) 
library(arrow) # lets us read/write parquet and feather files
library(sf) # "simple features" for spatial data
library(urbnmapr) # access to US state/country shapefiles for mapping
library(naniar) # tools for exploring and visualizing missing data
library(ggiraph) # makes ggplot charts interactive
options(scipen = 99) # turns off scientific notation

```

```{r}
teds_d <- read_parquet(here("data/teds_d_clean.parquet"))
head(teds_d)
```

## Question 1

Make an interactive map with `ggiraph` showing the percentage of completed treatments that end with no use at discharge. I am looking for a single interactive map as the final product.

Hint: Break this question down into bite-sized steps, like we did in Part 2. The `freq1_d` column contains information about use at discharge. Check your denominator carefully â€” should it be *all cases* or *completed cases*?

```{r}
percent_no_use <- teds_d %>%
  dplyr::filter(reason == "Treatment completed")%>%
group_by(stfips)%>%
  summarize(completed_cases = n(), no_use_count = sum(freq1_d == "no use", na.rm = TRUE))%>%
  mutate(pct_no_use = (no_use_count/completed_cases)*100)
summary(percent_no_use)

```

```{r}
states_map <- get_urbn_map(map = "states", sf = TRUE)
head(states_map, 10)

percent_no_use <- percent_no_use %>%
  mutate(state_fips = sprintf("%02d", stfips))

percent_no_use_state_map <- full_join(percent_no_use,
                          states_map,
                          by = "state_fips") 

 percent_no_use_state_map <- percent_no_use_state_map %>% 
  mutate(percentage_bin = cut(pct_no_use, breaks=c(0, 10, 20, 30, 40, 50, 60, 70, 80), include.lowest = TRUE))
 
 percent_complete_binned_int <- ggplot(percent_no_use_state_map) +
  geom_sf_interactive(
    aes(geometry = geometry,
      fill = percentage_bin,
      tooltip = paste( "State:", state_abbv,
                      "State FIPS:", stfips,
                      "<br>Completed:", pct_no_use, "%")),
    color = "#ffffff", size = 0.25) +
  labs(fill = "% of Completed Treatments with no use at discharge",
       title = "Completed Treatment Episodes by State",
       subtitle = "TEDS-D Dataset (SAMHSA)") +
  scale_fill_viridis_d(option = "mako", direction = -1) + # i flipped the direction of the color scale so dark = high and light = low
  coord_sf(datum = NA) +
  theme_minimal() +
  theme(panel.background = element_blank(),
    axis.ticks = element_blank(),
    axis.text.x = element_blank(),
    axis.text.y = element_blank(),
    legend.text = element_text(size = 4),
    legend.title = element_text(size = 5),
    strip.text = element_text(size = 4))

## Fixing West Virginia insert (na.value = "pink") after "direction = -1"##

girafe(ggobj = percent_complete_binned_int)
```

## Question 2

Treatment outcomes can vary depending on the type of service patients receive and the length of stay in treatment.

-   Investigate how the percentage of treatments completed and the percentage of treatments that end with no use at discharge differ when you look at service type and length of stay.

-   Create at least three different visualizations to help answer this question.

-   At least one visualization should focus on service type and at least one should focus on length of stay. A third visualization should compare the two.

-   After making your visualizations, write a short summary (3-ish sentences) that explains the main patterns you observe. Please use full, grammatical sentences.

```{r}
##treatments completed ##
group_service <- teds_d %>%
  mutate(
    completed = ifelse(reason == "Treatment completed", 1, 0),
    no_use = ifelse(reason == "no use", 1, 0)
  ) %>%
  group_by(services_d) %>%
  summarise(
    total_cases = n(),percent_completed = mean(completed, na.rm = TRUE) * 100, percent_no_use = mean(no_use, na.rm = TRUE) * 100
  ) %>%
  arrange(services_d)

group_service

##treatments no use at discharge ##
group_los <- teds_d %>%
  mutate(
    completed = ifelse(reason == "Treatment completed", 1, 0),
    no_use = ifelse(reason == "no use", 1, 0)
  ) %>%
  group_by(los) %>%
  summarise(
    total_cases = n(),
    percent_completed = mean(completed, na.rm = TRUE) * 100,
    percent_no_use = mean(no_use, na.rm = TRUE) * 100
  ) %>%
  arrange(los)

group_los
```

```{r}
## type of services visulaization
service_bar<-ggplot(teds_d, aes(x = reason, fill = services_d)) +
  geom_bar() +
  labs(
    title = "Distribution of Outcome by Service",
    x = "Outcome",
    y = "Number of Cases",
    fill = "Service Type"
  ) +
  theme(plot.title = element_text(size = 5)) +
  theme_minimal() +
  theme(axis.text.x = element_text(size = 5, angle = 90)) 
#girafe(ggobj = service_bar)
## length of stay visualization ##
los_box<-ggplot(teds_d, aes(x = reason, y = los)) +
  geom_boxplot(fill = "blue") +
  labs(
    title = "Length of Stay by Treatment Outcome", x = "Outcome", y = "Length of Stay (days)"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
#girafe(ggobj = los_box)
##distribution of length of stay ##
los_hist<-ggplot(teds_d, aes(x = los)) +
  geom_histogram(binwidth = 1, fill = "green", color = "black") +
  labs(
    title = "Length of Stay Distribution", x = "Length of Stay (days)", y = "Number of Cases"
  ) +
  theme_minimal()
#girafe(ggobj = los_hist)
ggplotly(service_bar)
```

Summary: The most successful patients who completed their treatment with no use at discharge seem to be those under the "Ambulatory, non-intesive outpatient" category. On the other hand, the type of service with the least amount of completed treatment services with no use at discharge was the ambulatory detox category. This conclusion is logical because according to the code book this category is for patients who were being tended to in a hospital setting "24 hours a day" which had a similar level of restriction to the rehab (non-detox) category which is the second lowest category in producing patients who complete treatment with no use at discharge. One theory I propse for the reasoning of this, is because these categories require the most surveillance of patients which is the most intense level of freedom restriction compared to the other service types. This drastic change in freedom would understandably make most patients feel pressured and unable to want to continue treatment. Those who completed their treatments were in the treatment centers for around 30 days on average (box plot) which also is supported by the histogram which tells us that most cases lead to a length of days of at least 30 days.

## Push to GitHub to Submit!

Assignment is due Tuesday 10/7 at 11:59 pm.
